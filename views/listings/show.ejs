<% layout("/layouts/boilerplate") %>

<div class="row mt-3">
  <div class="col-10 offset-1">
    <h2><%= listing.title %></h2>

    <div class="card listing-card">
      <img src="<%= listing.image.url %>" class="card-img-top show-img" alt="listing_image">
      <div class="card-body">
        <p class="card-text">Owned by <i><%= listing.owner.username %></i></p>
      </div>
    </div>
    
    <div class="row mt-3">
      <div class="col-md-8">
        <p><%= listing.description %></p>
        <p><%= listing.location %></p>
        <p><%= listing.country %></p>

        <% if (currUser && listing.owner._id.equals(currUser._id)) { %>
          <div class="d-flex mt-3">
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark edit-btn me-2">Edit</a>
            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
              <button class="btn btn-dark delete-btn me-1">Delete</button>
            </form>
          </div>
        <% } %>
      </div>

      <div class="col-md-4">
        <div id="booking-widget" class="card booking-widget p-3 border shadow-sm" data-price="<%= listing.price %>">
          <h4>&#8377;<%= listing.price.toLocaleString("en-IN")%><span class="booking-night-text"><b style="font-size: large;">/night</b></span></h4>
          <hr>
          
          <form action="/book" method="POST">
            <div class="mb-2">
              <label for="checkin" class="form-label"><b>CHECK-IN</b></label>
              <input type="date" id="checkin" name="checkin" class="form-control" required>
            </div>
            <div class="mb-3">
              <label for="checkout" class="form-label"><b>CHECK-OUT</b></label>
              <input type="date" id="checkout" name="checkout" class="form-control" required>
            </div>
            
            <button type="submit" class="btn btn-danger w-100">Reserve</button>

            <div id="price-details" class="mt-3" style="display: none;">
                <hr>
                <h5 class="mb-3">Price Details</h5>
                <div class="d-flex justify-content-between">
                    <span>&#8377;<%= listing.price.toLocaleString('en-IN') %> x <span id="num-nights">0</span> nights</span>
                    <span id="subtotal">&#8377; 0</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Service Fee</span>
                    <span>&#8377; 500</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                    <span>Total</span>
                    <span id="total-price">&#8377; 500</span>
                </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <hr class="mt-5">
    <% if (listing.reviews.length > 0) { %>
    <div class="average-rating mb-4">
      <h4>
        <i class="fas fa-star"></i> <%= avgRating %> &middot; <%= listing.reviews.length %> Reviews
      </h4>
    </div>
  <% } %>
    <p><b>All Reviews</b></p>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <% for (let review of listing.reviews) { %>
        <div class="col">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title"><%= review.author?.username || "Anonymous" %></h5>
              <p class="starability-result card-text" data-rating="<%= review.rating %>"></p>
              <p class="card-text"><%= review.comment %></p>
            </div>
            <div class="card-footer bg-transparent border-top-0">
              <form method="post" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                <button class="btn btn-dark btn-sm">Delete</button>
              </form>
            </div>
          </div>
        </div>
      <% } %>
    </div>    
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const checkinInput = document.getElementById('checkin');
    const checkoutInput = document.getElementById('checkout');
    const bookingWidget = document.getElementById('booking-widget');
    const priceDetails = document.getElementById('price-details');
    
    // Get all the spans we need to update
    const numNightsSpan = document.getElementById('num-nights');
    const subtotalSpan = document.getElementById('subtotal');
    const totalPriceSpan = document.getElementById('total-price');

    const pricePerNight = parseInt(bookingWidget.dataset.price, 10);
    const serviceFee = 500; // You can make this dynamic if needed

    function updatePrice() {
      const checkinDate = new Date(checkinInput.value);
      const checkoutDate = new Date(checkoutInput.value);

      if (checkinInput.value && checkoutInput.value && checkoutDate > checkinDate) {
        const timeDiff = checkoutDate.getTime() - checkinDate.getTime();
        const numNights = Math.ceil(timeDiff / (1000 * 3600 * 24));
        
        const subtotal = pricePerNight * numNights;
        const total = subtotal + serviceFee;

        numNightsSpan.innerText = numNights;
        subtotalSpan.innerText = `₹ ${subtotal.toLocaleString('en-IN')}`;
        totalPriceSpan.innerText = `₹ ${total.toLocaleString('en-IN')}`;
        
        priceDetails.style.display = 'block'; // Show the price details
      } else {
        // Hide price details if dates are invalid or not selected
        priceDetails.style.display = 'none'; 
      }
    }

    checkinInput.addEventListener('change', updatePrice);
    checkoutInput.addEventListener('change', updatePrice);
  });
</script>